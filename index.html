<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å‹¢é»é¤ç³»çµ±</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #333; }

        /* éš±è—è¦–è¨Šæºï¼Œä½†å¿…é ˆå­˜åœ¨æ–¼ DOM ä¸­æ‰èƒ½é€²è¡Œåµæ¸¬ */
        #webcam-container {
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0; /* é€æ˜åº¦è¨­ç‚º 0ï¼Œè¦–è¦ºä¸Šçœ‹ä¸è¦‹ï¼Œä½†ç¨‹å¼ä»èƒ½è®€å– */
            pointer-events: none; /* è®“æ»‘é¼ å¯ä»¥ç©¿é€ */
            z-index: -1;
        }

        /* ç‹€æ…‹åˆ— */
        #status-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        .dot.active { background-color: #00ff00; }

        /* èœå–®ç¶²æ ¼ */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3æ¬„ */
            gap: 20px;
            max-width: 800px;
            width: 100%;
            margin-top: 20px;
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        .menu-item img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .menu-item h3 { margin: 10px 0 5px; }
        .menu-item p { color: #888; margin: 0; }

        /* ç•¶è¢«æ‰‹å‹¢é¸ä¸­æ™‚çš„æ¨£å¼ */
        .menu-item.selected {
            border-color: #007bff;
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,123,255,0.3);
        }

        /* è³¼ç‰©è»Šæç¤º */
        #cart-feedback {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        /* è¼‰å…¥é®ç½© */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* æç¤ºå¡ */
        .instruction {
            margin-bottom: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            color: #555;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h2>æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹...</h2>
        <button id="startBtn" disabled>å•Ÿå‹•é»é¤ç³»çµ±</button>
    </div>

    <h1>ğŸ” éš”ç©ºæ‰‹å‹¢é»é¤</h1>
    
    <div class="instruction">
        ğŸ‘‹ <b>æ®å‹•æ‰‹æŒ</b>ï¼šä¸Šä¸‹å·¦å³åˆ‡æ›é¸æ“‡ &nbsp;|&nbsp; ğŸ‘Œ <b>æ‹‡æŒ‡é£ŸæŒ‡æåˆ</b>ï¼šç¢ºèªé»é¤
    </div>

    <div id="status-bar">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">ç³»çµ±å¾…å‘½</span>
    </div>

    <div class="menu-grid" id="menu">
        <!-- èœå–®é …ç›®ç”± JS ç”¢ç”Ÿ -->
    </div>

    <div id="cart-feedback">å·²åŠ å…¥è³¼ç‰©è»Šï¼</div>

    <!-- éš±è—çš„ Webcam -->
    <div id="webcam-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // --- 1. èœå–®è³‡æ–™è¨­å®š ---
        const menuItems = [
            { name: "ç¶“å…¸æ¼¢å ¡", price: "$120", icon: "ğŸ”" },
            { name: "å¤§ä»½è–¯æ¢", price: "$55", icon: "ğŸŸ" },
            { name: "å†°å¯æ¨‚", price: "$30", icon: "ğŸ¥¤" },
            { name: "ç‚¸é›å¡Š", price: "$80", icon: "ğŸ—" },
            { name: "ç†±ç‹—å ¡", price: "$70", icon: "ğŸŒ­" },
            { name: "å†°æ·‡æ·‹", price: "$40", icon: "ğŸ¦" },
            { name: "ç”Ÿèœæ²™æ‹‰", price: "$60", icon: "ğŸ¥—" },
            { name: "é»‘å’–å•¡", price: "$50", icon: "â˜•" },
            { name: "æŠ«è–©åˆ‡ç‰‡", price: "$90", icon: "ğŸ•" }
        ];

        let selectedIndex = 0; // ç•¶å‰é¸ä¸­çš„ç´¢å¼•
        const COLUMNS = 3;     // ç¶²æ ¼åˆ—æ•¸ (å°æ‡‰ CSS grid-template-columns)

        // ç”¢ç”Ÿ HTML
        const menuContainer = document.getElementById('menu');
        menuItems.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `menu-item ${index === 0 ? 'selected' : ''}`; // é è¨­é¸ä¸­ç¬¬ä¸€å€‹
            div.id = `item-${index}`;
            div.innerHTML = `
                <div style="font-size: 50px;">${item.icon}</div>
                <h3>${item.name}</h3>
                <p>${item.price}</p>
            `;
            menuContainer.appendChild(div);
        });

        // --- 2. è®Šæ•¸èˆ‡è¨­å®š ---
        const video = document.getElementById("webcam");
        const statusText = document.getElementById("status-text");
        const statusDot = document.getElementById("status-dot");
        const startBtn = document.getElementById("startBtn");
        const loadingOverlay = document.getElementById("loading-overlay");
        const cartFeedback = document.getElementById("cart-feedback");

        let handLandmarker = undefined;
        let lastVideoTime = -1;
        let lastX = null;
        let lastY = null;
        
        // åƒæ•¸èª¿æ•´
        const SWIPE_THRESHOLD = 0.04; // æ»‘å‹•è§¸ç™¼é–€æª»
        const COOLDOWN_MS = 600;      // æ»‘å‹•å†·å»æ™‚é–“
        const PINCH_THRESHOLD = 0.05; // æåˆè§¸ç™¼è·é›¢ (0.05 ä»¥ä¸‹ç®—æåˆ)
        
        let lastActionTime = 0;
        let isPinching = false; // é¿å…æåˆæ™‚é€£çºŒè§¸ç™¼

        // --- 3. åˆå§‹åŒ– MediaPipe ---
        async function createHandLandmarker() {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
            );
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
            startBtn.textContent = "é–‹å§‹ä½¿ç”¨";
            startBtn.disabled = false;
        }
        createHandLandmarker();

        // --- 4. å•Ÿå‹•é‚è¼¯ ---
        startBtn.addEventListener("click", async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                loadingOverlay.style.display = "none";
                statusDot.classList.add("active");
                statusText.innerText = "åµæ¸¬ä¸­...";
            } catch (err) {
                alert("ç„¡æ³•é–‹å•Ÿé¡é ­");
            }
        });

        // --- 5. æ ¸å¿ƒåµæ¸¬å¾ªç’° ---
        async function predictWebcam() {
            let startTimeMs = performance.now();
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, startTimeMs);

                if (results.landmarks.length > 0) {
                    const landmarks = results.landmarks[0];
                    
                    // A. è™•ç†æ»‘å‹• (ä½¿ç”¨é£ŸæŒ‡æŒ‡å°– Index 8)
                    handleSwipe(landmarks[8].x, landmarks[8].y);

                    // B. è™•ç†æåˆ (é£ŸæŒ‡ 8 èˆ‡ æ‹‡æŒ‡ 4 çš„è·é›¢)
                    handlePinch(landmarks[8], landmarks[4]);

                } else {
                    lastX = null; 
                    lastY = null;
                }
            }
            window.requestAnimationFrame(predictWebcam);
        }

        // --- 6. è™•ç†æ»‘å‹• (åˆ‡æ›ç„¦é») ---
        function handleSwipe(x, y) {
            const now = Date.now();
            if (now - lastActionTime < COOLDOWN_MS) return; // å†·å»ä¸­

            if (lastX === null || lastY === null) {
                lastX = x; lastY = y;
                return;
            }

            const dx = x - lastX;
            const dy = y - lastY;

            // X è»¸ç§»å‹• (å·¦å³)
            if (Math.abs(dx) > SWIPE_THRESHOLD && Math.abs(dx) > Math.abs(dy)) {
                // æ³¨æ„ï¼šé¡é ­æœ‰åš ScaleX(-1) è¦–è¦ºæ•ˆæœï¼Œä½† MediaPipe æ•¸æ“šæ˜¯åŸå§‹çš„
                // åŸå§‹æ•¸æ“š x è®Šå¤§æ˜¯å¾€å·¦ (å¦‚æœæ˜¯è‡ªæ‹é¡é ­æ²’é¡åƒ)ï¼Œx è®Šå°æ˜¯å¾€å³
                // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨é«”æ„Ÿæ¸¬è©¦ï¼š
                // dx > 0 (æ•¸å€¼è®Šå¤§) -> é€šå¸¸å°æ‡‰æ‰‹å¾€å³ç§» (åœ¨é¡åƒç•«é¢ä¸­) -> ä¸‹ä¸€å€‹
                // é€™è£¡å‡è¨­æ˜¯æ¨™æº– Webcam è¡Œç‚ºï¼Œè‹¥æ–¹å‘ç›¸åè«‹èª¿æ› logic
                if (dx > 0) moveSelection(1);  // Right / Next
                else moveSelection(-1);        // Left / Prev
                
                resetGestureState(now, x, y);
            } 
            // Y è»¸ç§»å‹• (ä¸Šä¸‹)
            else if (Math.abs(dy) > SWIPE_THRESHOLD) {
                if (dy > 0) moveSelection(COLUMNS);  // Down (å¢åŠ ä¸€åˆ—çš„ç´¢å¼•)
                else moveSelection(-COLUMNS);        // Up (æ¸›å°‘ä¸€åˆ—çš„ç´¢å¼•)

                resetGestureState(now, x, y);
            }
        }

        function resetGestureState(time, x, y) {
            lastActionTime = time;
            lastX = x;
            lastY = y;
        }

        // --- 7. è™•ç†æåˆ (ç¢ºèªé»é¤) ---
        function handlePinch(p1, p2) {
            // è¨ˆç®—æ­å¹¾é‡Œå¾—è·é›¢
            const distance = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
            
            if (distance < PINCH_THRESHOLD) {
                if (!isPinching) { // å‰›é–‹å§‹æåˆ
                    const now = Date.now();
                    // åŠ ä¸Šä¸€é»å†·å»æ™‚é–“ï¼Œé¿å…æ»‘å‹•å‰›çµæŸå°±èª¤è§¸
                    if (now - lastActionTime > 200) { 
                        triggerClick();
                        isPinching = true;
                    }
                }
            } else {
                isPinching = false; // æ”¾é–‹äº†
            }
        }

        // --- 8. UI æ›´æ–°é‚è¼¯ ---
        function moveSelection(offset) {
            // ç§»é™¤èˆŠçš„æ¨£å¼
            document.getElementById(`item-${selectedIndex}`).classList.remove('selected');

            // è¨ˆç®—æ–°ç´¢å¼• (é˜²æ­¢è¶…å‡ºç¯„åœ)
            let newIndex = selectedIndex + offset;
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= menuItems.length) newIndex = menuItems.length - 1;
            
            selectedIndex = newIndex;

            // åŠ ä¸Šæ–°æ¨£å¼
            const newItem = document.getElementById(`item-${selectedIndex}`);
            newItem.classList.add('selected');
            
            // è®“ç•«é¢æ²å‹•åˆ°é¸ä¸­é …ç›® (å¦‚æœåœ¨å¯è¦–ç¯„åœå¤–)
            newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function triggerClick() {
            const item = menuItems[selectedIndex];
            
            // è¦–è¦ºå›é¥‹
            cartFeedback.innerText = `å·²åŠ å…¥ï¼š${item.name} ${item.price}`;
            cartFeedback.style.opacity = '1';
            
            // æ¨¡æ“¬é»æ“Šæ•ˆæœ
            const domItem = document.getElementById(`item-${selectedIndex}`);
            domItem.style.backgroundColor = "#d4edda";
            setTimeout(() => {
                domItem.style.backgroundColor = "white";
                cartFeedback.style.opacity = '0';
            }, 1000);

            console.log(`Order placed: ${item.name}`);
        }

    </script>
</body>
</html>