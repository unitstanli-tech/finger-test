<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©©å®šç‰ˆæ‰‹å‹¢é»é¤</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ»¾å‹•ï¼Œå…¨é æ‰‹å‹¢ */
        }

        /* éš±è—è¦–è¨Šæº */
        #webcam-container {
            position: fixed; opacity: 0; pointer-events: none; z-index: -1;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        #status-bar {
            position: fixed; top: 10px; right: 10px;
            background: rgba(0,0,0,0.8); color: white;
            padding: 8px 15px; border-radius: 20px; font-size: 14px;
            display: flex; align-items: center; gap: 10px; z-index: 100;
        }
        .dot { width: 10px; height: 10px; background: red; border-radius: 50%; }
        .dot.active { background: #00ff00; }
        .pinch-indicator {
            width: 0%; height: 4px; background: #ffff00;
            transition: width 0.1s linear; border-radius: 2px;
        }

        /* èœå–®å€åŸŸ */
        .content-area {
            flex: 1; width: 100%; max-width: 800px;
            overflow-y: auto; padding-bottom: 100px;
        }

        .menu-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            padding: 10px;
        }

        .menu-item {
            background: white; border-radius: 12px; padding: 15px;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 3px solid transparent; transition: all 0.2s;
        }

        .menu-item.selected {
            border-color: #007bff; transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0,123,255,0.2);
        }
        
        /* çµå¸³æŒ‰éˆ• (ä½œç‚ºæœ€å¾Œä¸€å€‹å°èˆªé …ç›®) */
        #checkout-btn {
            margin: 20px auto; padding: 20px; width: 90%;
            background: #28a745; color: white; text-align: center;
            border-radius: 12px; font-size: 20px; font-weight: bold;
            border: 4px solid transparent; opacity: 0.8;
        }
        #checkout-btn.selected {
            border-color: #fff; box-shadow: 0 0 0 4px #28a745, 0 10px 20px rgba(0,0,0,0.2);
            opacity: 1; transform: scale(1.02);
        }

        /* å½ˆçª— Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 15px;
            text-align: center; width: 300px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .modal-buttons {
            margin-top: 20px; display: flex; justify-content: space-around;
        }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 16px; }
        .btn-confirm { background: #007bff; color: white; }
        .btn-cancel { background: #e9ecef; color: #333; }
        
        /* ç•¶å‰ Modal é¸é …æ¨£å¼ */
        .btn.selected { box-shadow: 0 0 0 3px #ffc107; transform: scale(1.1); }

        /* è³¼ç‰©è»Šå°æç¤º */
        #cart-feedback {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px;
            border-radius: 30px; opacity: 0; transition: opacity 0.3s;
        }
    </style>
</head>
<body>

    <div id="status-bar">
        <div class="dot" id="status-dot"></div>
        <span>æ‰‹å‹¢å¾…å‘½</span>
        <div style="width: 50px; background: #555; height: 4px; border-radius: 2px;">
            <div class="pinch-indicator" id="pinch-bar"></div>
        </div>
    </div>

    <h1>ğŸ¤ ç©©å®šç‰ˆæ‰‹å‹¢é»é¤</h1>

    <div class="content-area">
        <div class="menu-grid" id="menu">
            <!-- JS ç”Ÿæˆèœå–® -->
        </div>
        
        <!-- é€™æ˜¯å°èˆªçš„æœ€å¾Œä¸€å€‹é …ç›® -->
        <div id="checkout-btn">
            ğŸ›’ ä¸‹å–®çµå¸³
        </div>
    </div>

    <div id="cart-feedback">å·²åŠ å…¥</div>

    <!-- ç¢ºèªé€å–®å½ˆçª— -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box">
            <h2>ç¢ºèªé€å‡ºè¨‚å–®ï¼Ÿ</h2>
            <p>é€å‡ºå¾Œå»šæˆ¿å°‡é–‹å§‹è£½ä½œ</p>
            <div class="modal-buttons">
                <!-- é€™å…©å€‹æŒ‰éˆ•ä¹Ÿæ˜¯å°èˆªç¯€é» -->
                <button class="btn btn-cancel" id="modal-cancel">å–æ¶ˆ</button>
                <button class="btn btn-confirm" id="modal-confirm">ç¢ºèªé€å–®</button>
            </div>
        </div>
    </div>

    <div id="webcam-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // --- è¨­å®šåƒæ•¸ (èª¿æ ¡æ‰‹æ„Ÿçš„æ ¸å¿ƒ) ---
        // 1. æ»‘å‹•éˆæ•åº¦ï¼šæ•¸å­—è¶Šå¤§è¶Šé›£è§¸ç™¼ï¼ˆè¶Šä¸å®¹æ˜“èª¤è§¸ï¼‰
        const SWIPE_THRESHOLD = 0.08; 
        // 2. å†·å»æ™‚é–“ï¼šæ»‘å‹•ä¸€æ¬¡å¾Œï¼Œå¹¾æ¯«ç§’å…§ä¸èƒ½å†æ¬¡æ»‘å‹• (é˜²æ­¢é€£çºŒè·³æ ¼)
        const COOLDOWN_MS = 800; 
        // 3. æåˆè§¸ç™¼è·é›¢
        const PINCH_DISTANCE = 0.06;
        // 4. æåˆéœ€è¦ç¶­æŒçš„æ™‚é–“ (æ¯«ç§’)ï¼Œé˜²èª¤è§¸é—œéµ
        const PINCH_HOLD_TIME = 600; 
        // 5. å¹³æ»‘ä¿‚æ•¸ (0.0 ~ 1.0)ï¼šè¶Šå°è¶Šå¹³æ»‘ä½†è¶Šæœ‰å»¶é²æ„Ÿï¼Œå»ºè­° 0.2-0.3
        const SMOOTHING_FACTOR = 0.2; 

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let selectedIndex = 0; // 0 ~ (menuItems.length) -> æœ€å¾Œä¸€å€‹æ˜¯ checkout
        let isInModal = false; // æ˜¯å¦åœ¨å½ˆçª—æ¨¡å¼
        let modalIndex = 1;    // 0: Cancel, 1: Confirm (é è¨­é¸ç¢ºèª)
        
        let lastActionTime = 0;
        let pinchStartTime = 0;
        
        // å¹³æ»‘åŒ–åº§æ¨™ç”¨
        let smoothX = null;
        let smoothY = null;
        let refX = null; // å‹•ä½œåŸºæº–é»
        let refY = null;

        // UI å…ƒç´ 
        const menuItemsData = [
            { name: "æ¼¢å ¡", icon: "ğŸ”" }, { name: "è–¯æ¢", icon: "ğŸŸ" }, { name: "å¯æ¨‚", icon: "ğŸ¥¤" },
            { name: "ç‚¸é›", icon: "ğŸ—" }, { name: "ç†±ç‹—", icon: "ğŸŒ­" }, { name: "å’–å•¡", icon: "â˜•" }
        ];
        const COLUMNS = 3;
        const CHECKOUT_INDEX = menuItemsData.length; // çµå¸³æŒ‰éˆ•çš„ç´¢å¼•
        
        // ç”Ÿæˆ UI
        const menuContainer = document.getElementById('menu');
        menuItemsData.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `menu-item ${index === 0 ? 'selected' : ''}`;
            div.id = `item-${index}`;
            div.innerHTML = `<h3>${item.icon}</h3><p>${item.name}</p>`;
            menuContainer.appendChild(div);
        });

        // å•Ÿå‹• MediaPipe
        let handLandmarker = undefined;
        async function startApp() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                const video = document.getElementById("webcam");
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    document.getElementById("status-dot").classList.add("active");
                    predictWebcam();
                });
            } catch (err) { alert("è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™"); }
        }
        startApp();

        // æ ¸å¿ƒåµæ¸¬ Loop
        async function predictWebcam() {
            const video = document.getElementById("webcam");
            let startTimeMs = performance.now();

            if (handLandmarker && video.currentTime > 0) {
                const results = handLandmarker.detectForVideo(video, startTimeMs);

                if (results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    const rawX = lm[8].x; // é£ŸæŒ‡ X
                    const rawY = lm[8].y; // é£ŸæŒ‡ Y
                    const thumb = lm[4];  // æ‹‡æŒ‡

                    // 1. åº§æ¨™å¹³æ»‘åŒ– (Low Pass Filter) - è§£æ±ºæ‰‹æŠ–å•é¡Œ
                    if (smoothX === null) { smoothX = rawX; smoothY = rawY; }
                    else {
                        smoothX = smoothX * (1 - SMOOTHING_FACTOR) + rawX * SMOOTHING_FACTOR;
                        smoothY = smoothY * (1 - SMOOTHING_FACTOR) + rawY * SMOOTHING_FACTOR;
                    }

                    // 2. è™•ç†æåˆ (Pinch)
                    processPinch(lm[8], thumb);

                    // 3. è™•ç†æ»‘å‹• (Swipe) - åªæœ‰æ²’åœ¨æåˆæ™‚æ‰åµæ¸¬æ»‘å‹•
                    if (Date.now() - pinchStartTime > 200) { 
                        processSwipe(smoothX, smoothY);
                    }
                } else {
                    // æ‰‹é›¢é–‹ç•«é¢ï¼Œé‡ç½®åŸºæº–é»ï¼Œé¿å…ä¸‹æ¬¡é€²å…¥æ™‚äº‚è·³
                    refX = null; refY = null;
                    resetPinchUI();
                }
            }
            window.requestAnimationFrame(predictWebcam);
        }

        // --- é‚è¼¯ï¼šæåˆ (é•·æŒ‰ç¢ºèª) ---
        function processPinch(p1, p2) {
            const distance = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
            const bar = document.getElementById('pinch-bar');

            if (distance < PINCH_DISTANCE) {
                if (pinchStartTime === 0) pinchStartTime = Date.now();
                
                // è¨ˆç®—é€²åº¦
                const elapsed = Date.now() - pinchStartTime;
                const progress = Math.min((elapsed / PINCH_HOLD_TIME) * 100, 100);
                bar.style.width = `${progress}%`;

                if (elapsed > PINCH_HOLD_TIME) {
                    // è§¸ç™¼ç¢ºèªï¼
                    triggerSelect();
                    pinchStartTime = 0; // é‡ç½®
                    bar.style.width = "0%";
                    // çµ¦ä¸€é»å†·å»ï¼Œé¿å…ä¸€æ¬¡æåˆè§¸ç™¼å…©æ¬¡
                    lastActionTime = Date.now() + 500; 
                }
            } else {
                resetPinchUI();
            }
        }

        function resetPinchUI() {
            pinchStartTime = 0;
            document.getElementById('pinch-bar').style.width = "0%";
        }

        // --- é‚è¼¯ï¼šæ»‘å‹• (ç›¸å°ä½ç§») ---
        function processSwipe(x, y) {
            const now = Date.now();
            if (now - lastActionTime < COOLDOWN_MS) return;

            // åˆå§‹åŒ–åŸºæº–é»
            if (refX === null) { refX = x; refY = y; return; }

            const dx = x - refX; // ä½ç§»é‡
            const dy = y - refY;

            // åˆ¤æ–·æ˜¯å¦è¶…éé–€æª»
            if (Math.abs(dx) > SWIPE_THRESHOLD || Math.abs(dy) > SWIPE_THRESHOLD) {
                // æ‰¾å‡ºç§»å‹•æœ€å¤šçš„è»¸å‘
                if (Math.abs(dx) > Math.abs(dy)) {
                    // å·¦å³ç§»å‹• (é¡åƒ: xè®Šå¤§æ˜¯å¾€å·¦ï¼Œxè®Šå°æ˜¯å¾€å³)
                    // é€™è£¡çš„é‚è¼¯ï¼šdx > 0 ä»£è¡¨åŸå§‹ç•«é¢å¾€å·¦ï¼Œé¡åƒå¾Œæ‰‹çœ‹èµ·ä¾†æ˜¯å¾€å³ -> Next
                    navigate(dx > 0 ? 1 : -1); 
                } else {
                    // ä¸Šä¸‹ç§»å‹•
                    // dy > 0 ä»£è¡¨å¾€ä¸‹
                    navigate(dy > 0 ? 'down' : 'up');
                }
                
                // è§¸ç™¼å¾Œé‡ç½®åŸºæº–é»ï¼Œä¸¦é€²å…¥å†·å»
                refX = x; refY = y;
                lastActionTime = now;
            }
        }

        // --- å°èˆªæ§åˆ¶å™¨ (State Machine) ---
        function navigate(direction) {
            if (isInModal) {
                // å½ˆçª—æ¨¡å¼ï¼šå·¦å³åˆ‡æ› (0:å–æ¶ˆ, 1:ç¢ºèª)
                if (direction === 1 || direction === -1) {
                    modalIndex = modalIndex === 0 ? 1 : 0;
                    updateModalUI();
                }
                return;
            }

            // ä¸€èˆ¬æ¨¡å¼
            let nextIndex = selectedIndex;

            if (typeof direction === 'string') {
                // ä¸Šä¸‹
                if (direction === 'down') {
                    // å¦‚æœåœ¨ä¸€èˆ¬èœå–®ï¼Œå¾€ä¸‹è·³ä¸€è¡Œ
                    if (selectedIndex < menuItemsData.length - COLUMNS) nextIndex += COLUMNS;
                    // å¦‚æœåœ¨æœ€å¾Œä¸€è¡Œï¼Œå¾€ä¸‹è·³åˆ°çµå¸³éˆ•
                    else if (selectedIndex < menuItemsData.length) nextIndex = CHECKOUT_INDEX;
                } else if (direction === 'up') {
                    // å¦‚æœåœ¨çµå¸³éˆ•ï¼Œå¾€ä¸Šè·³å›æœ€å¾Œä¸€å€‹èœå–®é …ç›®
                    if (selectedIndex === CHECKOUT_INDEX) nextIndex = menuItemsData.length - 1;
                    // æ™®é€šå¾€ä¸Š
                    else if (selectedIndex >= COLUMNS) nextIndex -= COLUMNS;
                }
            } else {
                // å·¦å³
                nextIndex += direction;
            }

            // é‚Šç•Œæª¢æŸ¥
            if (nextIndex < 0) nextIndex = 0;
            if (nextIndex > CHECKOUT_INDEX) nextIndex = CHECKOUT_INDEX;

            selectedIndex = nextIndex;
            updateMenuUI();
        }

        // --- è§¸ç™¼ç¢ºèª/é»æ“Š ---
        function triggerSelect() {
            if (isInModal) {
                // å½ˆçª—å…§çš„ç¢ºèªé‚è¼¯
                if (modalIndex === 1) { // ç¢ºèªé€å–®
                    alert("âœ… è¨‚å–®å·²é€å‡ºï¼å»šæˆ¿æº–å‚™ä¸­...");
                    closeModal();
                    // é‡ç½®é é¢ç‹€æ…‹
                    selectedIndex = 0;
                    updateMenuUI();
                } else { // å–æ¶ˆ
                    closeModal();
                }
            } else {
                // ä¸€èˆ¬é é¢çš„é»æ“Šé‚è¼¯
                if (selectedIndex === CHECKOUT_INDEX) {
                    openModal();
                } else {
                    // åŠ å…¥è³¼ç‰©è»Š
                    const item = menuItemsData[selectedIndex];
                    const feedback = document.getElementById('cart-feedback');
                    feedback.innerText = `å·²åŠ å…¥ï¼š${item.name}`;
                    feedback.style.opacity = 1;
                    setTimeout(() => feedback.style.opacity = 0, 1000);
                    
                    // è¦–è¦ºå›é¥‹
                    const el = document.getElementById(`item-${selectedIndex}`);
                    el.style.backgroundColor = "#d4edda";
                    setTimeout(() => el.style.backgroundColor = "white", 300);
                }
            }
        }

        // --- UI æ›´æ–°å‡½å¼ ---
        function updateMenuUI() {
            // æ¸…é™¤æ‰€æœ‰é¸ä¸­
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('selected'));
            document.getElementById('checkout-btn').classList.remove('selected');

            if (selectedIndex === CHECKOUT_INDEX) {
                const btn = document.getElementById('checkout-btn');
                btn.classList.add('selected');
                btn.scrollIntoView({ behavior: 'smooth' });
            } else {
                const el = document.getElementById(`item-${selectedIndex}`);
                if (el) {
                    el.classList.add('selected');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function openModal() {
            isInModal = true;
            modalIndex = 1; // é è¨­é¸ç¢ºèª
            document.getElementById('confirm-modal').style.display = 'flex';
            updateModalUI();
        }

        function closeModal() {
            isInModal = false;
            document.getElementById('confirm-modal').style.display = 'none';
        }

        function updateModalUI() {
            const btnCancel = document.getElementById('modal-cancel');
            const btnConfirm = document.getElementById('modal-confirm');
            
            btnCancel.classList.remove('selected');
            btnConfirm.classList.remove('selected');

            if (modalIndex === 0) btnCancel.classList.add('selected');
            else btnConfirm.classList.add('selected');
        }

    </script>
</body>
</html>