<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å‹¢é»é¤ç³»çµ± (å«æ¸¸æ¨™)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            cursor: none; /* éš±è—æ»‘é¼ æ¸¸æ¨™ï¼Œæ”¹ç”¨æˆ‘å€‘è‡ªè£½çš„æ‰‹å‹¢æ¸¸æ¨™ */
        }

        /* éš±è—è¦–è¨Šæº */
        #webcam-container {
            position: fixed; opacity: 0; pointer-events: none; z-index: -1;
        }

        /* --- æ–°å¢ï¼šè™›æ“¬æ¸¸æ¨™æ¨£å¼ --- */
        #virtual-cursor {
            position: fixed;
            width: 30px;
            height: 30px;
            background-color: rgba(255, 0, 0, 0.6);
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ï¼Œä¸æœƒæ“‹ä½ä¸‹æ–¹å…ƒç´  */
            z-index: 9999;
            transform: translate(-50%, -50%); /* è®“åº§æ¨™ä½æ–¼åœ“å¿ƒ */
            display: none; /* é è¨­éš±è—ï¼Œåµæ¸¬åˆ°æ‰‹æ‰é¡¯ç¤º */
            transition: width 0.2s, height 0.2s, background-color 0.2s;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        /* æåˆæ™‚çš„æ¸¸æ¨™æ¨£å¼ */
        #virtual-cursor.pinching {
            width: 20px;
            height: 20px;
            background-color: #ffff00; /* è®Šæˆé»ƒè‰² */
            box-shadow: 0 0 15px #ffff00;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        #status-bar {
            position: fixed; top: 10px; right: 10px;
            background: rgba(0,0,0,0.8); color: white;
            padding: 8px 15px; border-radius: 20px; font-size: 14px;
            display: flex; align-items: center; gap: 10px; z-index: 100;
        }
        .dot { width: 10px; height: 10px; background: red; border-radius: 50%; }
        .dot.active { background: #00ff00; }
        .pinch-indicator {
            width: 0%; height: 4px; background: #ffff00;
            transition: width 0.1s linear; border-radius: 2px;
        }

        /* èœå–®å€åŸŸ */
        .content-area {
            flex: 1; width: 100%; max-width: 800px;
            overflow-y: auto; padding-bottom: 100px;
            /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
            scrollbar-width: none; 
        }
        .content-area::-webkit-scrollbar { display: none; }

        .menu-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            padding: 10px;
        }

        .menu-item {
            background: white; border-radius: 12px; padding: 15px;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 3px solid transparent; transition: all 0.2s;
        }

        .menu-item.selected {
            border-color: #007bff; transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0,123,255,0.2);
        }
        
        #checkout-btn {
            margin: 20px auto; padding: 20px; width: 90%;
            background: #28a745; color: white; text-align: center;
            border-radius: 12px; font-size: 20px; font-weight: bold;
            border: 4px solid transparent; opacity: 0.8;
        }
        #checkout-btn.selected {
            border-color: #fff; box-shadow: 0 0 0 4px #28a745, 0 10px 20px rgba(0,0,0,0.2);
            opacity: 1; transform: scale(1.02);
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 15px;
            text-align: center; width: 300px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: space-around; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 16px; }
        .btn-confirm { background: #007bff; color: white; }
        .btn-cancel { background: #e9ecef; color: #333; }
        .btn.selected { box-shadow: 0 0 0 3px #ffc107; transform: scale(1.1); }

        #cart-feedback {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px;
            border-radius: 30px; opacity: 0; transition: opacity 0.3s;
        }
    </style>
</head>
<body>

    <!-- è™›æ“¬æ¸¸æ¨™å…ƒä»¶ -->
    <div id="virtual-cursor"></div>

    <div id="status-bar">
        <div class="dot" id="status-dot"></div>
        <span>æ‰‹å‹¢åµæ¸¬ä¸­</span>
        <div style="width: 50px; background: #555; height: 4px; border-radius: 2px;">
            <div class="pinch-indicator" id="pinch-bar"></div>
        </div>
    </div>

    <h1>ğŸ¤ éš”ç©ºé»é¤ (æ¸¸æ¨™ç‰ˆ)</h1>

    <div class="content-area">
        <div class="menu-grid" id="menu"></div>
        <div id="checkout-btn">ğŸ›’ ä¸‹å–®çµå¸³</div>
    </div>

    <div id="cart-feedback">å·²åŠ å…¥</div>

    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box">
            <h2>ç¢ºèªé€å‡ºè¨‚å–®ï¼Ÿ</h2>
            <p>é€å‡ºå¾Œå»šæˆ¿å°‡é–‹å§‹è£½ä½œ</p>
            <div class="modal-buttons">
                <button class="btn btn-cancel" id="modal-cancel">å–æ¶ˆ</button>
                <button class="btn btn-confirm" id="modal-confirm">ç¢ºèªé€å–®</button>
            </div>
        </div>
    </div>

    <div id="webcam-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // --- è¨­å®šåƒæ•¸ ---
        const SWIPE_THRESHOLD = 0.08; 
        const COOLDOWN_MS = 800; 
        const PINCH_DISTANCE = 0.06;
        const PINCH_HOLD_TIME = 600; 
        const SMOOTHING_FACTOR = 0.2; 

        let selectedIndex = 0;
        let isInModal = false;
        let modalIndex = 1; 
        let lastActionTime = 0;
        let pinchStartTime = 0;
        
        // å¹³æ»‘åŒ–åº§æ¨™
        let smoothX = null;
        let smoothY = null;
        // å‹•ä½œåŸºæº–é»
        let refX = null; 
        let refY = null;

        const menuItemsData = [
            { name: "æ¼¢å ¡", icon: "ğŸ”" }, { name: "è–¯æ¢", icon: "ğŸŸ" }, { name: "å¯æ¨‚", icon: "ğŸ¥¤" },
            { name: "ç‚¸é›", icon: "ğŸ—" }, { name: "ç†±ç‹—", icon: "ğŸŒ­" }, { name: "å’–å•¡", icon: "â˜•" },
            { name: "å†°æ·‡æ·‹", icon: "ğŸ¦" }, { name: "æ²™æ‹‰", icon: "ğŸ¥—" }, { name: "æŠ«è–©", icon: "ğŸ•" }
        ];
        const COLUMNS = 3;
        const CHECKOUT_INDEX = menuItemsData.length;

        // UI åˆå§‹åŒ–
        const menuContainer = document.getElementById('menu');
        const virtualCursor = document.getElementById('virtual-cursor');
        
        menuItemsData.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `menu-item ${index === 0 ? 'selected' : ''}`;
            div.id = `item-${index}`;
            div.innerHTML = `<h3>${item.icon}</h3><p>${item.name}</p>`;
            menuContainer.appendChild(div);
        });

        // MediaPipe åˆå§‹åŒ–
        let handLandmarker = undefined;
        async function startApp() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                const video = document.getElementById("webcam");
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    document.getElementById("status-dot").classList.add("active");
                    predictWebcam();
                });
            } catch (err) { alert("è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™"); }
        }
        startApp();

        async function predictWebcam() {
            const video = document.getElementById("webcam");
            let startTimeMs = performance.now();

            if (handLandmarker && video.currentTime > 0) {
                const results = handLandmarker.detectForVideo(video, startTimeMs);

                if (results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    const rawX = lm[8].x; 
                    const rawY = lm[8].y; 
                    const thumb = lm[4]; 

                    // 1. åº§æ¨™å¹³æ»‘åŒ–
                    if (smoothX === null) { smoothX = rawX; smoothY = rawY; }
                    else {
                        smoothX = smoothX * (1 - SMOOTHING_FACTOR) + rawX * SMOOTHING_FACTOR;
                        smoothY = smoothY * (1 - SMOOTHING_FACTOR) + rawY * SMOOTHING_FACTOR;
                    }

                    // 2. æ›´æ–°è™›æ“¬æ¸¸æ¨™ (é—œéµæ”¹å‹•)
                    updateCursor(smoothX, smoothY);

                    // 3. è™•ç†æåˆ
                    processPinch(lm[8], thumb);

                    // 4. è™•ç†æ»‘å‹• (åªæœ‰æ²’åœ¨æåˆæ™‚æ‰åµæ¸¬)
                    if (Date.now() - pinchStartTime > 200) { 
                        processSwipe(smoothX, smoothY);
                    }
                } else {
                    refX = null; refY = null;
                    resetPinchUI();
                    // æ²’æ‰‹çš„æ™‚å€™éš±è—æ¸¸æ¨™
                    virtualCursor.style.display = 'none';
                }
            }
            window.requestAnimationFrame(predictWebcam);
        }

        // --- æ›´æ–°æ¸¸æ¨™ä½ç½® ---
        function updateCursor(x, y) {
            // MediaPipe çš„ x=0 æ˜¯ç•«é¢å·¦é‚Šï¼Œx=1 æ˜¯å³é‚Šã€‚
            // ä½†å› ç‚ºæˆ‘å€‘çœ‹è¢å¹•åƒç…§é¡å­ï¼Œæ‰€ä»¥ï¼š
            // ç•¶ä½ çš„æ‰‹å¾€å³ç§»å‹•ï¼Œé¡é ­(æœªé¡åƒ)æœƒçœ‹åˆ°æ‰‹å¾€å³(xè®Šå¤§)ï¼Œä½†ç‚ºäº†è®“æ¸¸æ¨™è·Ÿæ‰‹åŒæ–¹å‘ï¼Œ
            // è¢å¹•ä¸Šçš„æ¸¸æ¨™æ‡‰è©²ä¹Ÿè¦å¾€å³ã€‚
            // è¨ˆç®—ï¼š
            // screenX = (1 - x) * 100vw  (æ°´å¹³ç¿»è½‰ï¼Œç¬¦åˆé¡åƒç›´è¦º)
            // screenY = y * 100vh        (å‚ç›´ä¸è®Š)
            
            const screenX = (1 - x) * 100;
            const screenY = y * 100;

            virtualCursor.style.display = 'block';
            virtualCursor.style.left = `${screenX}vw`;
            virtualCursor.style.top = `${screenY}vh`;
        }

        function processPinch(p1, p2) {
            const distance = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
            const bar = document.getElementById('pinch-bar');

            if (distance < PINCH_DISTANCE) {
                if (pinchStartTime === 0) pinchStartTime = Date.now();
                
                // æ¸¸æ¨™æåˆç‰¹æ•ˆ
                virtualCursor.classList.add('pinching');

                const elapsed = Date.now() - pinchStartTime;
                const progress = Math.min((elapsed / PINCH_HOLD_TIME) * 100, 100);
                bar.style.width = `${progress}%`;

                if (elapsed > PINCH_HOLD_TIME) {
                    triggerSelect();
                    pinchStartTime = 0; 
                    bar.style.width = "0%";
                    lastActionTime = Date.now() + 500; 
                }
            } else {
                resetPinchUI();
            }
        }

        function resetPinchUI() {
            pinchStartTime = 0;
            document.getElementById('pinch-bar').style.width = "0%";
            virtualCursor.classList.remove('pinching'); // ç§»é™¤ç‰¹æ•ˆ
        }

        function processSwipe(x, y) {
            const now = Date.now();
            if (now - lastActionTime < COOLDOWN_MS) return;

            if (refX === null) { refX = x; refY = y; return; }

            const dx = x - refX;
            const dy = y - refY;

            if (Math.abs(dx) > SWIPE_THRESHOLD || Math.abs(dy) > SWIPE_THRESHOLD) {
                if (Math.abs(dx) > Math.abs(dy)) {
                    // æ°´å¹³ç¿»è½‰ä¿®æ­£ï¼šdx > 0 ä»£è¡¨åŸå§‹xè®Šå¤§(å¾€å³)ï¼Œä½†æˆ‘å€‘åšäº†é¡åƒ
                    // å¯¦éš›ä¸Šåœ¨é¡åƒç•«é¢ä¸­ï¼Œæ‰‹å¾€å³(Cursor Right) = xè®Šå° = dx < 0
                    // æ‰€ä»¥ï¼š
                    // dx > 0 (åŸå§‹å¾€å³/é¡åƒå¾€å·¦) -> Prev (-1)
                    // dx < 0 (åŸå§‹å¾€å·¦/é¡åƒå¾€å³) -> Next (1)
                    // (ä½†é€™å–æ±ºæ–¼ä½ çš„æ”å½±æ©Ÿæ˜¯å¦æœ¬èº«æœ‰é¡åƒï¼Œé€šå¸¸ WebCam æ˜¯æœªé¡åƒçš„)
                    // è®“æˆ‘å€‘è§€å¯Ÿæ¸¸æ¨™ï¼šæ¸¸æ¨™æ˜¯ (1-x)ã€‚
                    // å¦‚æœæ‰‹å¾€å³ -> x è®Šå° -> (1-x) è®Šå¤§ -> æ¸¸æ¨™å¾€å³ã€‚
                    // æ­¤æ™‚ dx (current - old) æ˜¯è² æ•¸ã€‚
                    // æ‰€ä»¥ dx < 0 ä»£è¡¨å¾€å³ã€‚
                    navigate(dx < 0 ? 1 : -1); 
                } else {
                    navigate(dy > 0 ? 'down' : 'up');
                }
                
                refX = x; refY = y;
                lastActionTime = now;
            }
        }

        function navigate(direction) {
            if (isInModal) {
                if (direction === 1 || direction === -1) {
                    modalIndex = modalIndex === 0 ? 1 : 0;
                    updateModalUI();
                }
                return;
            }

            let nextIndex = selectedIndex;
            if (typeof direction === 'string') {
                if (direction === 'down') {
                    if (selectedIndex < menuItemsData.length - COLUMNS) nextIndex += COLUMNS;
                    else if (selectedIndex < menuItemsData.length) nextIndex = CHECKOUT_INDEX;
                } else if (direction === 'up') {
                    if (selectedIndex === CHECKOUT_INDEX) nextIndex = menuItemsData.length - 1;
                    else if (selectedIndex >= COLUMNS) nextIndex -= COLUMNS;
                }
            } else {
                nextIndex += direction;
            }

            if (nextIndex < 0) nextIndex = 0;
            if (nextIndex > CHECKOUT_INDEX) nextIndex = CHECKOUT_INDEX;

            selectedIndex = nextIndex;
            updateMenuUI();
        }

        function triggerSelect() {
            if (isInModal) {
                if (modalIndex === 1) { 
                    alert("âœ… è¨‚å–®å·²é€å‡ºï¼");
                    closeModal();
                    selectedIndex = 0;
                    updateMenuUI();
                } else { closeModal(); }
            } else {
                if (selectedIndex === CHECKOUT_INDEX) {
                    openModal();
                } else {
                    const item = menuItemsData[selectedIndex];
                    const feedback = document.getElementById('cart-feedback');
                    feedback.innerText = `å·²åŠ å…¥ï¼š${item.name}`;
                    feedback.style.opacity = 1;
                    setTimeout(() => feedback.style.opacity = 0, 1000);
                    
                    const el = document.getElementById(`item-${selectedIndex}`);
                    el.style.backgroundColor = "#d4edda";
                    setTimeout(() => el.style.backgroundColor = "white", 300);
                }
            }
        }

        function updateMenuUI() {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('selected'));
            document.getElementById('checkout-btn').classList.remove('selected');

            if (selectedIndex === CHECKOUT_INDEX) {
                const btn = document.getElementById('checkout-btn');
                btn.classList.add('selected');
                btn.scrollIntoView({ behavior: 'smooth' });
            } else {
                const el = document.getElementById(`item-${selectedIndex}`);
                if (el) {
                    el.classList.add('selected');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function openModal() {
            isInModal = true;
            modalIndex = 1; 
            document.getElementById('confirm-modal').style.display = 'flex';
            updateModalUI();
        }
        function closeModal() {
            isInModal = false;
            document.getElementById('confirm-modal').style.display = 'none';
        }
        function updateModalUI() {
            const btnCancel = document.getElementById('modal-cancel');
            const btnConfirm = document.getElementById('modal-confirm');
            btnCancel.classList.remove('selected');
            btnConfirm.classList.remove('selected');
            if (modalIndex === 0) btnCancel.classList.add('selected');
            else btnConfirm.classList.add('selected');
        }
    </script>
</body>
</html>